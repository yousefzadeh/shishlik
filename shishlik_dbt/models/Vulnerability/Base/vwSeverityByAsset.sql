with
    severity as (
        select distinct
            a.Asset_Title Asset_Title,
            v.Vulnerability_Id,
            v.Vulnerability_TenantId,
            v.Vulnerability_IdRef,
            v.Vulnerability_Title,
            v.Vulnerability_Severity,
            v.Vulnerability_Priority,
            v.Vulnerability_AssetHostIPOrDomainId,
            v.Vulnerability_Status,
            vmt.VulnerabilityMappingTemplate_TemplateName,
            v.Vulnerability_SeverityCode,
            v.Vulnerability_PriorityCode,
            v.Vulnerability_StatusCode,
            ahid.AssetHostIPOrDomain_HostIPRegisterItemId HostIP,
            ahid.AssetHostIPOrDomain_DomainRegisterItemId Domain
        from {{ ref("vwVulnerability") }} v
        join
            {{ ref("vwVulnerabilityImportFileLog") }} vifl
            on vifl.VulnerabilityImportFileLog_Id = v.Vulnerability_VulnerabilityImportFileLogId
        join
            {{ ref("vwVulnerabilityMappingTemplate") }} vmt
            on vmt.VulnerabilityMappingTemplate_Id = vifl.VulnerabilityImportFileLog_VulnerabilityMappingTemplateId
        join
            {{ ref("vwAssetHostIPOrDomain") }} ahid
            on ahid.AssetHostIPOrDomain_Id = v.Vulnerability_AssetHostIPOrDomainId
            and ahid.AssetHostIPOrDomain_HostIPRegisterItemId is not null
        join {{ ref("vwAsset") }} a on a.Asset_Id = ahid.AssetHostIPOrDomain_HostIPRegisterItemId

        union all

        select
            -- 'No Linked Asset' Asset_Title 
            unlink.AssetHostIPOrDomain_HostIPOrDomain Asset_Title,
            v.Vulnerability_Id,
            v.Vulnerability_TenantId,
            v.Vulnerability_IdRef,
            v.Vulnerability_Title,
            v.Vulnerability_Severity,
            v.Vulnerability_Priority,
            v.Vulnerability_AssetHostIPOrDomainId,
            v.Vulnerability_Status,
            vmt.VulnerabilityMappingTemplate_TemplateName,
            v.Vulnerability_SeverityCode,
            v.Vulnerability_PriorityCode,
            v.Vulnerability_StatusCode,
            unlink.AssetHostIPOrDomain_HostIPRegisterItemId HostIP,
            unlink.AssetHostIPOrDomain_DomainRegisterItemId Domain
        from {{ ref("vwVulnerability") }} v
        join
            {{ ref("vwVulnerabilityImportFileLog") }} vifl
            on vifl.VulnerabilityImportFileLog_Id = v.Vulnerability_VulnerabilityImportFileLogId
        join
            {{ ref("vwVulnerabilityMappingTemplate") }} vmt
            on vmt.VulnerabilityMappingTemplate_Id = vifl.VulnerabilityImportFileLog_VulnerabilityMappingTemplateId
        join
            {{ ref("vwAssetHostIPOrDomain") }} unlink
            on unlink.AssetHostIPOrDomain_Id = v.Vulnerability_AssetHostIPOrDomainId
            and unlink.AssetHostIPOrDomain_HostIPRegisterItemId is null
    )

select
    Asset_Title,
    Vulnerability_Id,
    Vulnerability_TenantId,
    Vulnerability_IdRef,
    Vulnerability_Title,
    Vulnerability_Severity,
    Vulnerability_Priority,
    Vulnerability_AssetHostIPOrDomainId,
    Vulnerability_Status,
    VulnerabilityMappingTemplate_TemplateName,
    Vulnerability_SeverityCode,
    Vulnerability_PriorityCode,
    Vulnerability_StatusCode,
    HostIP,
    Domain
from
    severity sv