{{ config(materialized="view") }}

with
    base as (
        select
            Id,
            CreationTime,
            CreatorUserId,
            LastModificationTime,
            LastModifierUserId,
            DeleterUserId,
            DeletionTime,
            TenantId,
            IdRef,
            VulnerabilityImportFileLogId,
            Title,
            SourceId,
            Severity,
            case
                when Severity = 1
                then 'Critical'
                when Severity = 2
                then 'High'
                when Severity = 3
                then 'Medium'
                when Severity = 4
                then 'Low'
                when Severity = 5
                then 'None'
                else NULL
            end SeverityCode,
            Priority,
            case
                when Priority = 1
                then 'Highest'
                when Priority = 2
                then 'High'
                when Priority = 3
                then 'Medium'
                when Priority = 4
                then 'Low'
                when Priority = 5
                then 'None'
                else NULL
            end PriorityCode,
            AssetHostIPOrDomainId,
            CVEId,
            CVSS3BaseScore,
            CVSS3TemporalScore,
            CVSS2BaseScore,
            CVSS2TemporalScore,
            Status,
            case
                when Status = 1 then 'Open' when Status = 2 then 'Closed' when Status = 3 then 'Deferred' else NULL
            end StatusCode,
            SourceToolId,
            SourceTypeId,
            MarkForClosure,
            LastUpdatedVulnerabilityImportFileLogId
        from {{ source("vulnerability_models", "Vulnerability") }} {{ system_remove_IsDeleted() }}
    )

select
    {{ col_rename("Id", "Vulnerability") }},
    {{ col_rename("CreationTime", "Vulnerability") }},
    {{ col_rename("CreatorUserId", "Vulnerability") }},
    {{ col_rename("LastModificationTime", "Vulnerability") }},

    {{ col_rename("LastModifierUserId", "Vulnerability") }},
    {{ col_rename("DeleterUserId", "Vulnerability") }},
    {{ col_rename("DeletionTime", "Vulnerability") }},
    {{ col_rename("TenantId", "Vulnerability") }},

    {{ col_rename("IdRef", "Vulnerability") }},
    {{ col_rename("VulnerabilityImportFileLogId", "Vulnerability") }},
    {{ col_rename("Title", "Vulnerability") }},
    {{ col_rename("SourceId", "Vulnerability") }},

    {{ col_rename("Severity", "Vulnerability") }},
    {{ col_rename("SeverityCode", "Vulnerability") }},
    {{ col_rename("Priority", "Vulnerability") }},
    {{ col_rename("PriorityCode", "Vulnerability") }},
    {{ col_rename("AssetHostIPOrDomainId", "Vulnerability") }},
    {{ col_rename("CVEId", "Vulnerability") }},

    {{ col_rename("CVSS3BaseScore", "Vulnerability") }},
    {{ col_rename("CVSS3TemporalScore", "Vulnerability") }},
    {{ col_rename("CVSS2BaseScore", "Vulnerability") }},
    {{ col_rename("CVSS2TemporalScore", "Vulnerability") }},

    {{ col_rename("Status", "Vulnerability") }},
    {{ col_rename("StatusCode", "Vulnerability") }},
    {{ col_rename("SourceToolId", "Vulnerability") }},
    {{ col_rename("SourceTypeId", "Vulnerability") }},
    {{ col_rename("MarkForClosure", "Vulnerability") }},

    {{ col_rename("LastUpdatedVulnerabilityImportFileLogId", "Vulnerability") }}
from base
